# .github/workflows/cleanup-source-code.yml
# Workflow này nằm trong repo public (remox-release)
# Mục đích: Tự động xóa file source code ngay khi có release mới được publish.

name: Auto Clean Source Code Archives

# Kích hoạt workflow này khi một release được "published"
on:
  release:
    types: [published]

jobs:
  cleanup-source-assets:
    runs-on: ubuntu-latest

    # Cấp quyền cho GITHUB_TOKEN để có thể chỉnh sửa release (xóa asset)
    permissions:
      contents: write

    steps:
      - name: 🏷️ Get Release Tag Name
        id: get_tag
        # Lấy tên tag từ sự kiện đã trigger workflow (ví dụ: v1.0.32)
        run: echo "TAG_NAME=${{ github.event.release.tag_name }}" >> $GITHUB_ENV

      - name: 🗑️ Delete Source Code Archives
        env:
          # Sử dụng GITHUB_TOKEN mặc định của workflow, đã được cấp quyền ở trên
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "🧹 Cleaning up source code for release: ${{ env.TAG_NAME }}"

          # Lệnh xóa file zip. Dùng "--yes" để tự động xác nhận.
          # Dùng "|| true" để workflow không bị lỗi nếu file không tồn tại.
          gh release delete-asset "${{ env.TAG_NAME }}" "Source code (zip)" --yes || echo "ℹ️ 'Source code (zip)' not found or already deleted."

          # Lệnh xóa file tar.gz
          gh release delete-asset "${{ env.TAG_NAME }}" "Source code (tar.gz)" --yes || echo "ℹ️ 'Source code (tar.gz)' not found or already deleted."

      - name: ✅ Verify Final Assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "✅ Cleanup complete. Verifying final assets for ${{ env.TAG_NAME }}:"
          # In ra danh sách các file còn lại để xác nhận trong log
          gh release view "${{ env.TAG_NAME }}" --json assets --jq '.assets[].name'
