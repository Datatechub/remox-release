# .github/workflows/cleanup-source-code.yml
# Workflow nÃ y náº±m trong repo public (remox-release)
# Má»¥c Ä‘Ã­ch: Tá»± Ä‘á»™ng xÃ³a file source code ngay khi cÃ³ release má»›i Ä‘Æ°á»£c publish.

name: Auto Clean Source Code Archives

# KÃ­ch hoáº¡t workflow nÃ y khi má»™t release Ä‘Æ°á»£c "published"
on:
  release:
    types: [published]

jobs:
  cleanup-source-assets:
    runs-on: ubuntu-latest

    # Cáº¥p quyá»n cho GITHUB_TOKEN Ä‘á»ƒ cÃ³ thá»ƒ chá»‰nh sá»­a release (xÃ³a asset)
    permissions:
      contents: write

    steps:
      - name: ğŸ·ï¸ Get Release Tag Name
        id: get_tag
        # Láº¥y tÃªn tag tá»« sá»± kiá»‡n Ä‘Ã£ trigger workflow (vÃ­ dá»¥: v1.0.32)
        run: echo "TAG_NAME=${{ github.event.release.tag_name }}" >> $GITHUB_ENV

      - name: ğŸ—‘ï¸ Delete Source Code Archives
        env:
          # Sá»­ dá»¥ng GITHUB_TOKEN máº·c Ä‘á»‹nh cá»§a workflow, Ä‘Ã£ Ä‘Æ°á»£c cáº¥p quyá»n á»Ÿ trÃªn
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ§¹ Cleaning up source code for release: ${{ env.TAG_NAME }}"

          # Lá»‡nh xÃ³a file zip. DÃ¹ng "--yes" Ä‘á»ƒ tá»± Ä‘á»™ng xÃ¡c nháº­n.
          # DÃ¹ng "|| true" Ä‘á»ƒ workflow khÃ´ng bá»‹ lá»—i náº¿u file khÃ´ng tá»“n táº¡i.
          gh release delete-asset "${{ env.TAG_NAME }}" "Source code (zip)" --yes || echo "â„¹ï¸ 'Source code (zip)' not found or already deleted."

          # Lá»‡nh xÃ³a file tar.gz
          gh release delete-asset "${{ env.TAG_NAME }}" "Source code (tar.gz)" --yes || echo "â„¹ï¸ 'Source code (tar.gz)' not found or already deleted."

      - name: âœ… Verify Final Assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "âœ… Cleanup complete. Verifying final assets for ${{ env.TAG_NAME }}:"
          # In ra danh sÃ¡ch cÃ¡c file cÃ²n láº¡i Ä‘á»ƒ xÃ¡c nháº­n trong log
          gh release view "${{ env.TAG_NAME }}" --json assets --jq '.assets[].name'
